# UI 繪製原理與異步繪製 - 面試要點速查

## 快速回答模板

### Q1: 請描述 iOS 的 UI 繪製流程

**回答框架**：
```
1. 應用層（UIKit）
   ↓
2. Core Animation
   ↓
3. OpenGL ES / Metal
   ↓
4. GPU
   ↓
5. 顯示器
```

**詳細說明**：
- **CPU 階段**：佈局計算、視圖創建、圖像解碼、繪製準備
- **GPU 階段**：頂點處理、光柵化、片段處理、圖層合成
- **三個階段**：標記（setNeedsDisplay）→ 佈局（layoutSubviews）→ 繪製（draw）

**關鍵點**：
- 繪製不是實時的，在 RunLoop 週期執行
- 每個 UIView 對應一個 CALayer
- 實際渲染在 Layer 層級完成

---

### Q2: 什麼是離屏渲染？如何避免？

**定義**：
無法直接在當前屏幕緩衝區繪製，需要先在離屏緩衝區完成繪製，再切換到屏幕緩衝區。

**觸發條件**：
1. ❌ 圓角 + 裁切：`cornerRadius` + `masksToBounds = true`
2. ❌ 陰影：`layer.shadowPath` 未設置
3. ❌ 遮罩：`layer.mask`
4. ❌ 透明度：`allowsGroupOpacity` + alpha < 1
5. ❌ 光柵化：`shouldRasterize = true`

**避免方法**：
1. ✅ 使用 `shadowPath` 明確陰影路徑
2. ✅ 使用圖片實現圓角
3. ✅ 使用 Core Graphics 直接繪製圓角
4. ✅ 光柵化只用於靜態內容

---

### Q3: 什麼是異步繪製？為什麼需要？

**定義**：
將耗時的繪製操作從主線程移到後台線程執行。

**為什麼需要**：
- 同步繪製在主線程執行 `draw(_:)`
- 複雜繪製會阻塞主線程
- 造成界面卡頓，影響用戶體驗

**核心流程**：
```
主線程                    後台線程
  ↓
標記需要繪製
  ↓                        ↓
獲取繪製參數  ────────→  創建繪製任務
  ↓                        ↓
繼續響應用戶              在 CGContext 中繪製
  ↓                        ↓
  ↓                    生成 CGImage
  ↓                        ↓
設置 layer.contents  ←──  回調主線程
```

---

### Q4: 異步繪製的關鍵技術點是什麼？

**1. Generation Counter（代數計數器）**
```swift
var drawingGeneration: Int = 0

func asyncRedraw() {
    drawingGeneration += 1  // 新請求，增加代數
    let current = drawingGeneration
    
    // 後台繪製前檢查
    guard current == self.drawingGeneration else { return }
    
    // 更新前再次檢查
    guard current == self.drawingGeneration else { return }
}
```
**用途**：防止過期的繪製覆蓋新的繪製

**2. Drawing Context（參數快照）**
```swift
struct DrawingContext {
    let size: CGSize
    let text: String
    let font: UIFont
    // ... 所有繪製需要的參數
}

// 在主線程創建
let context = DrawingContext(...)

// 在後台線程使用
drawingQueue.async {
    drawContent(with: context)  // ✅ 安全
}
```
**用途**：避免在後台線程訪問 UI 屬性

**3. 位圖上下文創建**
```swift
let scale = UIScreen.main.scale
let context = CGContext(
    data: nil,
    width: Int(size.width * scale),
    height: Int(size.height * scale),
    bitsPerComponent: 8,
    bytesPerRow: 0,
    space: CGColorSpaceCreateDeviceRGB(),
    bitmapInfo: ...
)
context.scaleBy(x: scale, y: scale)
```
**用途**：在後台線程創建離屏繪製上下文

---

### Q5: 異步繪製的優缺點是什麼？

**優點**：
- ✅ 不阻塞主線程，提高流暢度
- ✅ 充分利用多核 CPU
- ✅ 適合複雜的文字和圖形繪製

**缺點**：
- ❌ 增加內存使用（需要額外緩衝區）
- ❌ 增加代碼複雜度（線程同步、狀態管理）
- ❌ 內容顯示有延遲
- ❌ 不適合頻繁變化的內容

---

### Q6: 什麼場景適合使用異步繪製？

**適合** ✅：
- 富文本渲染（微博、Twitter feed）
- 複雜的自定義圖表
- 大量圖形繪製
- 自定義的複雜控件

**不適合** ❌：
- 簡單的 UI 控件
- 頻繁變化的內容
- 實時動畫
- 內存受限的場景

---

### Q7: Core Animation 的三棵樹是什麼？

**1. Model Layer Tree（模型樹）**
- 我們直接操作的圖層
- 包含圖層的目標狀態
- 通過 `layer` 訪問

**2. Presentation Layer Tree（表現樹）**
- 動畫執行過程中的當前狀態
- 顯示當前幀的實際值
- 通過 `layer.presentation()` 訪問

**3. Render Tree（渲染樹）**
- 在獨立進程中（Render Server）
- 執行實際的繪製工作
- 無法直接訪問

---

### Q8: 如何優化 UI 繪製性能？

**繪製優化**：
1. 避免不必要的重繪
2. 使用 `isOpaque = true`（不透明視圖）
3. 只重繪需要更新的區域：`setNeedsDisplay(_:)`
4. 避免離屏渲染

**圖層優化**：
1. 減少視圖層級（扁平化）
2. 使用 CALayer 替代 UIView（更輕量）
3. 批量更新使用 `CATransaction`

**圖片優化**：
1. 圖片大小匹配顯示尺寸
2. 選擇合適的圖片格式
3. 在後台線程預解碼
4. 使用圖片緩存

**光柵化**：
```swift
layer.shouldRasterize = true
layer.rasterizationScale = UIScreen.main.scale
```
- 適用於靜態複雜內容
- 動態內容會降低性能

---

## 代碼示例

### 同步繪製
```swift
class SyncDrawingView: UIView {
    override func draw(_ rect: CGRect) {
        // ⚠️ 在主線程執行，會阻塞 UI
        guard let context = UIGraphicsGetCurrentContext() else { return }
        
        // 繪製背景
        context.setFillColor(UIColor.white.cgColor)
        context.fill(rect)
        
        // 繪製內容
        drawContent(in: context)
    }
}
```

### 異步繪製
```swift
class AsyncDrawingView: UIView {
    private var drawingGeneration: Int = 0
    private let drawingQueue = DispatchQueue(label: "drawing")
    
    func asyncRedraw() {
        // 1. 增加代數
        drawingGeneration += 1
        let current = drawingGeneration
        
        // 2. 在主線程捕獲參數
        let context = DrawingContext(
            size: bounds.size,
            text: text,
            font: font
        )
        
        // 3. 在後台線程繪製
        drawingQueue.async { [weak self] in
            guard let self = self else { return }
            guard current == self.drawingGeneration else { return }
            
            // 創建位圖上下文
            let cgContext = createBitmapContext(size: context.size)
            
            // 執行繪製
            drawContent(in: cgContext, context: context)
            
            // 生成圖片
            let image = cgContext.makeImage()
            
            // 4. 回到主線程更新
            DispatchQueue.main.async {
                guard current == self.drawingGeneration else { return }
                self.layer.contents = image
            }
        }
    }
}
```

---

## 性能指標

**目標**：
- 保持 60 FPS（每幀 16.67ms）
- 主線程繁忙時間 < 16ms
- GPU 利用率合理

**工具**：
- Instruments - Core Animation
- Instruments - Time Profiler
- Xcode Debug - Color Blended Layers
- Xcode Debug - Color Offscreen-Rendered

---

## 關鍵術語

| 術語 | 英文 | 說明 |
|------|------|------|
| 繪製 | Drawing | 在上下文中生成像素數據 |
| 渲染 | Rendering | 將像素數據顯示到屏幕 |
| 光柵化 | Rasterization | 將矢量圖形轉換為像素 |
| 合成 | Compositing | 將多個圖層混合 |
| 離屏渲染 | Offscreen Rendering | 在屏幕外緩衝區渲染 |
| 圖層混合 | Blending | 計算重疊圖層的顏色 |

---

## 面試技巧

### 回答結構
1. **定義**：簡潔說明是什麼
2. **原理**：解釋為什麼、怎麼做
3. **應用**：什麼場景使用
4. **優化**：如何提升性能
5. **實例**：舉實際例子

### 加分項
- 提到實際項目經驗
- 說明遇到的問題和解決方案
- 展示對性能的關注
- 了解底層原理（GPU、Metal）
- 知道業界最佳實踐（YYText）

### 避免
- 死記硬背，不理解原理
- 只說理論，沒有實踐
- 回答過於簡單或過於複雜
- 不知道適用場景
- 無法舉出實例

---

## 延伸問題

面試官可能會問：

1. **UIView 和 CALayer 的關係？**
   - UIView 負責事件處理和內容管理
   - CALayer 負責實際的繪製和動畫
   - 每個 UIView 有一個 layer 屬性

2. **setNeedsDisplay 和 setNeedsLayout 的區別？**
   - `setNeedsDisplay`：標記需要重繪，觸發 `draw(_:)`
   - `setNeedsLayout`：標記需要重新佈局，觸發 `layoutSubviews()`

3. **如何實現一個高性能的列表？**
   - 複用機制（UITableView/UICollectionView）
   - 異步繪製複雜內容
   - 圖片異步加載和解碼
   - 高度緩存
   - 按需加載

4. **Metal 和 OpenGL ES 的區別？**
   - Metal 是 Apple 的現代圖形 API
   - 更底層，性能更好
   - 更適合遊戲和複雜圖形

---

## 記憶口訣

**UI 繪製三步驟**：
- 標（setNeedsDisplay）
- 佈（layoutSubviews）
- 繪（draw）

**異步繪製三要素**：
- 代數計數器（防過期）
- 參數快照（保安全）
- 位圖上下文（做繪製）

**離屏渲染六觸發**：
- 圓角裁切
- 陰影無路徑
- 遮罩
- 透明度
- 抗鋸齒
- 光柵化

---

## 最後檢查清單

面試前確認：
- [ ] 能流暢描述 UI 繪製流程
- [ ] 理解同步和異步繪製的區別
- [ ] 知道異步繪製的三個關鍵技術點
- [ ] 能說出離屏渲染的觸發條件和避免方法
- [ ] 了解性能優化的常見手段
- [ ] 能舉出實際應用場景
- [ ] 準備好代碼示例（可以手寫）

---

**祝你面試成功！** 🎉

